<div class="main-container">
    <lib-sidebar></lib-sidebar>
    <div class="chat-box-container">
        <div class="chat-box-container">
            <mat-card class="ai-name">{{ aiName }}</mat-card>

            <div class="chat-messages" #chatContainer>
                <mat-card
                        *ngFor="let msg of chatMessages"
                        class="message"
                        [ngClass]="{ 'user': msg.role === 'user', 'model': msg.role === 'model' }"
                >
                    <div *ngIf="msg.role === 'user'">{{ msg.messages.join('') }}</div>
                    <markdown *ngIf="msg.role === 'model'" [data]="msg.messages.join('')"></markdown>
                    <ng-container *ngIf="msg.role === 'form'">
                        <button
                                mat-raised-button
                                color="accent"
                                (click)="checkForFormTrigger(msg.messages.join(''))"
                        >
                            Click To Open Form
                        </button>
                    </ng-container>
                </mat-card>
            </div>

            <mat-card class="chat-input-container">
              <!-- File Preview ABOVE the input -->
              <div *ngIf="selectedFiles.length > 0" class="file-chip-container">
                <div *ngFor="let file of selectedFiles; let i = index" class="file-chip">
                  <div class="file-icon">
                    <mat-icon>insert_drive_file</mat-icon>
                  </div>
                  <div class="file-name">{{ getShortenedFileName(file.name) }}</div>
                  <button mat-icon-button class="file-remove-btn" (click)="removeFile(i)">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Input Box -->
              <mat-form-field class="chat-input" appearance="outline">
                <input
                  matInput
                  placeholder="Type a message..."
                  [(ngModel)]="message"
                  (keyup.enter)="onSend()"
                />
              </mat-form-field>

              <!-- Buttons BELOW the input -->
              <div class="input-actions">
                <div class="left-actions">
                  <input
                    type="file"
                    accept=".csv, .xls, .xlsx"
                    multiple
                    (change)="onFilesSelected($event)"
                    hidden
                    #fileInput
                  />
                  <button
                    mat-icon-button
                    color="warn"
                    matTooltip="Attach file"
                    (click)="fileInput.click()"
                  >
                    <mat-icon>attach_file</mat-icon>
                  </button>
                </div>
                <div class="right-actions">
                  <button mat-icon-button color="accent" aria-label="Voice Input">
                    <mat-icon>mic</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="onSend()"
                    [disabled]="!message.trim()"
                  >
                    <mat-icon>send</mat-icon>
                  </button>
                </div>
              </div>
            </mat-card>
        </div>
    </div>
</div>
